

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>MPI Functions &mdash; Pandemic Exemplar (for those with some experience)</title>
    
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="Pandemic Exemplar (for those with some experience)" href="../index.html" />
    <link rel="next" title="Core Functions" href="../5-CoreFunctions/corefunctions.html" />
    <link rel="prev" title="Init Functions" href="../3-InitFunctions/initfunctions.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../5-CoreFunctions/corefunctions.html" title="Core Functions"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../3-InitFunctions/initfunctions.html" title="Init Functions"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">Pandemic Exemplar (for those with some experience)</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="mpi-functions">
<h1>MPI Functions<a class="headerlink" href="#mpi-functions" title="Permalink to this headline">¶</a></h1>
<div class="section" id="find-infected">
<h2>find_infected<a class="headerlink" href="#find-infected" title="Permalink to this headline">¶</a></h2>
<p>Each process determines its infected x locations and infected y
locations</p>
<div class="figure align-center">
<img alt="image" src="../_images/img-16.png" />
</div>
<p>We have already set the states of the infected people and the positions
of all the people, but we need to specifically set the positions of the
infected people and store them in the <strong>our_infected_x_locations</strong> and
<strong>our_infected_y_locations</strong> arrays. We do this by marching through the
<strong>our_states</strong> array and checking whether the state at each cell is
INFECTED. If it is, we add the locations of the current infected person
from the <strong>our_x_locations</strong> and <strong>our_y_locations</strong> arrays to the
<strong>our_infected_x_locations</strong> and <strong>our_infected_y_locations</strong> arrays. We
determine the ID of the current infected person using the
<strong>our_current_infected_person</strong> variable:</p>
<div class="highlight-c"><div class="highlight"><pre>    <span class="kt">int</span> <span class="n">our_current_infected_person</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="n">our_person1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">our_person1</span> <span class="o">&lt;=</span> <span class="n">our</span><span class="o">-&gt;</span><span class="n">our_number_of_people</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">our_person1</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="n">our</span><span class="o">-&gt;</span><span class="n">our_states</span><span class="p">[</span><span class="n">our_person1</span><span class="p">]</span> <span class="o">==</span> <span class="n">INFECTED</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">our</span><span class="o">-&gt;</span><span class="n">our_infected_x_locations</span><span class="p">[</span><span class="n">our_current_infected_person</span><span class="p">]</span> <span class="o">=</span> 
            <span class="n">our</span><span class="o">-&gt;</span><span class="n">our_x_locations</span><span class="p">[</span><span class="n">our_person1</span><span class="p">];</span>
            <span class="n">our</span><span class="o">-&gt;</span><span class="n">our_infected_y_locations</span><span class="p">[</span><span class="n">our_current_infected_person</span><span class="p">]</span> <span class="o">=</span>
            <span class="n">our</span><span class="o">-&gt;</span><span class="n">our_y_locations</span><span class="p">[</span><span class="n">our_person1</span><span class="p">];</span>
            <span class="n">our_current_infected_person</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="share-infected">
<h2>share_infected<a class="headerlink" href="#share-infected" title="Permalink to this headline">¶</a></h2>
<p>First, each process sends its count of infected people to all the other
processes and receives their counts</p>
<div class="figure align-center">
<img alt="image" src="../_images/img-17.png" />
</div>
<p>This step is handled by the MPI command <strong>MPI_Allgather</strong> whose arguments
are as follows:</p>
<ul class="simple">
<li><strong>&amp;our_num_infected</strong> – the address of the sending buffer (the thing being sent).</li>
<li><strong>1</strong> – the count of things being sent.</li>
<li><strong>MPI_INT</strong> – the datatype of things being sent.</li>
<li><strong>recvcounts</strong> – the receive buffer (an array of things being received).</li>
<li><strong>1</strong> – the count of things being received.</li>
<li><strong>MPI_INT</strong> – the datatype of things being received.</li>
<li><strong>MPI_COMM_WORLD</strong> – the communicator of processes that send and receive data.</li>
</ul>
<p>Once the data has been sent and received, we count the total number of
infected people by adding up the values in the <strong>recvcounts</strong> array and
storing the result in the <strong>total_num_infected</strong> variable:</p>
<div class="highlight-c"><div class="highlight"><pre>    <span class="n">global</span><span class="o">-&gt;</span><span class="n">total_num_infected</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">current_rank</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="n">current_rank</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">current_rank</span> <span class="o">&lt;=</span> <span class="n">total_number_of_processes</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">current_rank</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">global</span><span class="o">-&gt;</span><span class="n">total_num_infected</span> <span class="o">+=</span> <span class="n">recvcounts</span><span class="p">[</span><span class="n">current_rank</span><span class="p">];</span>
    <span class="p">}</span>
</pre></div>
</div>
<p>Next, each process sends the x locations of its infected people to all
the other processes and receives the x locations of their infected
people</p>
<p>For this send and receive, we need to use <strong>MPI_Allgatherv</strong> instead of
<strong>MPI_Allgather</strong>. This is because each process has a varying
number of infected people, so it needs to be able to send a variable
number of x locations. To do this, we first need to set up the
displacements in the receive buffer; that is, we need to indicate how
many elements each process will send and at what points in the receive
array they will appear. We can do this with a <strong>displs</strong> array, which will
contain a list of the displacements in the receive buffer:</p>
<div class="highlight-c"><div class="highlight"><pre>    <span class="kt">int</span> <span class="n">current_displ</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="n">current_rank</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">current_rank</span> <span class="o">&lt;=</span> <span class="n">total_number_of_processes</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">current_rank</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">displs</span><span class="p">[</span><span class="n">current_rank</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_displ</span><span class="p">;</span>
        <span class="n">current_displ</span> <span class="o">+=</span> <span class="n">recvcounts</span><span class="p">[</span><span class="n">current_rank</span><span class="p">];</span>
    <span class="p">}</span>
</pre></div>
</div>
<p>We are now ready to call the <strong>MPI_Allgatherv</strong>. Here are its arguments:</p>
<ul class="simple">
<li><strong>our_infected_x_locations</strong> – the send buffer (array of things to send).</li>
<li><strong>our_num_infected</strong> – the count of elements in the send buffer.</li>
<li><strong>MPI_INT</strong> – the datatype of the elements in the send buffer.</li>
<li><strong>their_infected_x_locations</strong> – the receive buffer (array of things to receive).</li>
<li><strong>recvcounts</strong> – an array of counts of elements in the receive buffer</li>
<li><strong>displs</strong> – the list of displacements in the receive buffer, as determined above.</li>
<li><strong>MPI_INT</strong> – the data type of the elements in the receive buffer.</li>
<li><strong>MPI_COMM_WORLD</strong> – the communicator of processes that send and receive data.</li>
</ul>
<p>Once the command is complete, each process will have the full array of
the x locations of the infected people from each process, stored in the
<strong>their_infected_x_locations</strong> array.</p>
<p>Finally, each process sends the y locations of its infected people to all
the other processes and receives the y locations of their infected
people</p>
<p>The y locations are sent and received just as the x locations are sent
and received. In fact, the function calls have exactly 2 letters
difference; the x’s in the <strong>Allgatherv</strong> from last step. are replaced by
y’s in the <strong>Allgatherv</strong> in this step.</p>
<p>Note that the code will only execute previous two steps if MPI is
enabled. If it is not enabled, the code simply copies the
<strong>our_infected_x_locations</strong> and <strong>our_infected_y_locations</strong> arrays into
the <strong>their_infected_x_locations</strong> and <strong>their_infected_y_locations</strong>
arrays and the <strong>our_num_infected</strong> variable into the <strong>total_num_infected</strong>
variable.</p>
</div>
<div class="section" id="share-location">
<h2>share_location<a class="headerlink" href="#share-location" title="Permalink to this headline">¶</a></h2>
<p>If display is enabled, Rank 0 gathers the states, x locations,
and y locations of the people for which each process is responsible</p>
<div class="figure align-center">
<img alt="image" src="../_images/img-18.png" />
</div>
<p>We set up the displs here just as we did in function share_infected. Three calls to
Gatherv take place for each process to send each of their <strong>our_states</strong>,
<strong>our_x_locations</strong>, and <strong>our_y_locations arrays</strong>. Rank 0 copies these
into its <strong>states</strong>, <strong>x_locations</strong>, and <strong>y_locations</strong> arrays, respectively.
Note that if MPI is not enabled, Rank 0 just does a direct copy of the
arrays without using Gatherv.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/CSInParallel200wide.png" alt="Logo"/>
            </a></p>
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">MPI Functions</a><ul>
<li><a class="reference internal" href="#find-infected">find_infected</a></li>
<li><a class="reference internal" href="#share-infected">share_infected</a></li>
<li><a class="reference internal" href="#share-location">share_location</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="../3-InitFunctions/initfunctions.html"
                        title="previous chapter">Init Functions</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../5-CoreFunctions/corefunctions.html"
                        title="next chapter">Core Functions</a></p>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../5-CoreFunctions/corefunctions.html" title="Core Functions"
             >next</a> |</li>
        <li class="right" >
          <a href="../3-InitFunctions/initfunctions.html" title="Init Functions"
             >previous</a> |</li>
        <li><a href="../index.html">Pandemic Exemplar (for those with some experience)</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright This work is licensed under a Creative Commons Attribution-ShareAlike 3.0 Unported License.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>