<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Mandelbrot OpenMP Lab &mdash; Thread Programming for Mid-level Courses</title>
    
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="top" title="Thread Programming for Mid-level Courses" href="../index.html" />
    <link rel="next" title="Mandelbrot OpenMP Homework" href="../MandelbrotOpenMPHomework/MandelbrotOpenMPHomework.html" />
    <link rel="prev" title="Counting Primes Homework" href="../CountingPrimesHomework/CountingPrimesHomework.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../MandelbrotOpenMPHomework/MandelbrotOpenMPHomework.html" title="Mandelbrot OpenMP Homework"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../CountingPrimesHomework/CountingPrimesHomework.html" title="Counting Primes Homework"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">Thread Programming for Mid-level Courses</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="mandelbrot-openmp-lab">
<h1>Mandelbrot OpenMP Lab<a class="headerlink" href="#mandelbrot-openmp-lab" title="Permalink to this headline">¶</a></h1>
<p>In this lab, you’ll look at using OpenMP to use multiple threads to speed up a computationally-intensive task.</p>
<p>The files that you should download (<a class="reference download internal" href="../_downloads/mandelbrot.c"><tt class="xref download docutils literal"><span class="pre">mandelbrot.c</span></tt></a> and <a class="reference download internal" href="../_downloads/bmp.h"><tt class="xref download docutils literal"><span class="pre">bmp.h</span></tt></a>) are a program to draw an image. Compile them with</p>
<div class="highlight-bash"><div class="highlight"><pre>gcc -Wall -std<span class="o">=</span>c99 -o mandelbrot mandelbrot.c
</pre></div>
</div>
<p>and run the resulting executable; it takes a single command line argument, which should be a filename ending in <tt class="docutils literal"><span class="pre">.bmp</span></tt>. This extension stands for “bitmap”, which is a graphics format. The program will create the file whose name you give.</p>
<p>The image that appears is a bitmap created by the program. It is a complicated black and white figure representing the Mandelbrot set. You can read more about this set on Wikipedia (or other online sources), but a short explanation is that this figure is based on repeating a simple mathematical operation and seeing if the result becomes unboundedly large. The specific operation depends on the pair of coordinates being considered. A point that is in the set (appearing black in the diagram) is one whose operation yields a bounded value (ideally forever, though we only look for 1,000 iterations of the operation). Points appearing white in the diagram are not in the set, meaning that the operation applied to their coordinates grew past a threshold within the first 1,000 iterations.</p>
<p>Now open the code to examine the program. It begins by writing the header of a bitmap file. Then it fills in a two-dimensional array called <tt class="docutils literal"><span class="pre">pixels</span></tt> that stores the desired color of each pixel. It concludes by writing the contents of this array into the file. For a single pixel, the <tt class="docutils literal"><span class="pre">mandelbrot</span></tt> function determines whether that pixel should be drawn as in the set or not. The bulk of the program’s running time is a series of calls to this function from <tt class="docutils literal"><span class="pre">main</span></tt>, right after the comment <tt class="docutils literal"><span class="pre">“set</span> <span class="pre">pixels”</span></tt>. Find this comment and examine that paragraph of code. You’re welcome to examine the mandelbrot function, a detailed understanding of which is not necessary for the lab. Its most important feature is that it returns either <tt class="docutils literal"><span class="pre">0</span></tt> or <tt class="docutils literal"><span class="pre">255</span></tt> depending on whether the pixel at the given coordinates should be drawn as black or white. The pixels themselves are represented with three bytes each; each of these bytes should be a number 0–255 that gives the desired intensity of one color at a specific location; the colors represented are red, green, and blue. Other colors are displayed by showing combinations of these colors. To facilitate saving these triples of bytes to a file, the color values of each pixel are stored in a struct called <tt class="docutils literal"><span class="pre">RGBTRIPLE</span></tt> that is defined in <tt class="docutils literal"><span class="pre">bmp.h</span></tt>. The lines</p>
<div class="highlight-c"><div class="highlight"><pre><span class="n">pixels</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">].</span><span class="n">rgbtBlue</span> <span class="o">=</span> <span class="n">color</span><span class="p">;</span>
<span class="n">pixels</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">].</span><span class="n">rgbtGreen</span> <span class="o">=</span> <span class="n">color</span><span class="p">;</span>
<span class="n">pixels</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">].</span><span class="n">rgbtRed</span> <span class="o">=</span> <span class="n">color</span><span class="p">;</span>
</pre></div>
</div>
<p>are accessing one of these structures out of the 2D array and setting its fields.</p>
<p>As you may have noticed, this program takes a fair amount of time to run. Use the time program to measure how long it takes:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nb">time </span>mandelbrot blah.bmp
</pre></div>
</div>
<p>where <tt class="docutils literal"><span class="pre">blah.bmp</span></tt> is replaced with the name of the file you’d like to create. (Note that when doing timing experiments like this, it matters what else is running on the system. You want the system to have a consistent amount of free processing power each time you time a run.)</p>
<p>The focus of this lab will be in trying to reduce this delay. To do so, you’ll be using the OpenMP, which is a standard for thread-based parallel programming. Before getting started, run the following on the command line:</p>
<div class="highlight-bash"><div class="highlight"><pre>setenv OMP_NUM_THREADS 2
</pre></div>
</div>
<p>This tells OpenMP that you want to use 2 threads by setting an environment variable (configuration information that the shell keeps track of for you). If you don’t use it, then OpenMP will use a number of threads equal to the number of cores available, which will obscure the effects we’re trying to observe.</p>
<p>Next add the line</p>
<div class="highlight-c"><div class="highlight"><pre><span class="cp">#pragma omp parallel for</span>
</pre></div>
</div>
<p>immediately after the comment <tt class="docutils literal"><span class="pre">&quot;set</span> <span class="pre">pixels&quot;</span></tt> (and before the outer for loop). A pragma is a hint to the compiler. In this case, you’re telling it that you want it to use <tt class="docutils literal"><span class="pre">omp</span></tt> (OpenMP) to parallelize the immediately following for loop. Multiple threads will be created, each responsible for completing some of the loop iterations. All of these threads will join at the end of the loop.</p>
<p>To compile with this pragma, add <tt class="docutils literal"><span class="pre">-fopenmp</span></tt> to your compile line or you’ll get a warning about the pragma being ignored (and the code will be compiled without it).</p>
<p>When you run this version of the program, you’ll see that the output isn’t quite right; the resulting image will look slightly grainy, with some white pixels in the interior and some black ones outside. This is because the variables <tt class="docutils literal"><span class="pre">x</span></tt>, <tt class="docutils literal"><span class="pre">y</span></tt>, and <tt class="docutils literal"><span class="pre">color</span></tt> in the loop are shared. Both threads are using these variables, causing them to sometimes use values written by the other thread. This is a classic race condition. To resolve it, add <tt class="docutils literal"><span class="pre">private(x,y,color)</span></tt> to the end of the pragma. This tells the compiler to create private copies of these three variables for each thread.</p>
<p>After this change, the parallel version should produce identical output to the original serial version (confirm this). Use time to compare the running time of the two versions. The first two numbers from time should be nearly identical because the programs do almost exactly the same things and therefore need the same amount of CPU time. The wall clock times (next number) should differ, though. The speedup of our parallel implementation is the serial wall clock time divided by the parallel wall clock time. Since we are using two threads and the computers have enough cores to run each on a separate thread, an ideal speedup would be 2. Yours is likely less than this, but should be greater than 1.</p>
<p>Now that you’ve successfully parallelized the program one way, try the following variations:</p>
<ol class="arabic simple">
<li>Swap the order of the two loops, moving the <tt class="docutils literal"><span class="pre">j</span></tt> for loop to the outside, so that the pragma is attached to it.</li>
<li>Try the loops in the original order, but with the pragma moved inside the outer loop so that it’s attached to the inner loop on <tt class="docutils literal"><span class="pre">j</span></tt>.</li>
<li>Do the same, but with the order swapped. (<tt class="docutils literal"><span class="pre">j</span></tt> loop on the outside, but the pragma inside it to parallelize the inner <tt class="docutils literal"><span class="pre">i</span></tt> loop.)</li>
<li>Run with the loops in the original order and the pragma on the outer loop, but with <tt class="docutils literal"><span class="pre">schedule(dynamic)</span></tt> added to the end of the pragma. Without this directive, the program splits the loop iterations between the two threads before any of them run. With it, the iterations are split into small groups and each thread gets a new group when it completes the group it is working on.</li>
<li>Use variations of the <tt class="docutils literal"><span class="pre">setenv</span></tt> command above to change the number of threads being used. (Try other powers of 2: 4, 8, 16, 32.) You don’t need to recompile for this change to take effect; just enter a new <tt class="docutils literal"><span class="pre">setenv</span></tt> line and rerun your executable.</li>
</ol>
<p>For each of these variations, compute the speedup and see if you can make sense of the results.</p>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/CSInParallel200wide.png" alt="Logo"/>
            </a></p>
  <h4>Previous topic</h4>
  <p class="topless"><a href="../CountingPrimesHomework/CountingPrimesHomework.html"
                        title="previous chapter">Counting Primes Homework</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../MandelbrotOpenMPHomework/MandelbrotOpenMPHomework.html"
                        title="next chapter">Mandelbrot OpenMP Homework</a></p>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../MandelbrotOpenMPHomework/MandelbrotOpenMPHomework.html" title="Mandelbrot OpenMP Homework"
             >next</a> |</li>
        <li class="right" >
          <a href="../CountingPrimesHomework/CountingPrimesHomework.html" title="Counting Primes Homework"
             >previous</a> |</li>
        <li><a href="../index.html">Thread Programming for Mid-level Courses</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright This work is licensed under a Creative Commons Attribution-ShareAlike 3.0 Unported License.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
  </body>
</html>