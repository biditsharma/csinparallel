

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Activities &mdash; Heterogeneous Computing</title>
    
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="Heterogeneous Computing" href="../index.html" />
    <link rel="next" title="The Three Musketeers" href="../TheThreeMusketeers/TheThreeMusketeers.html" />
    <link rel="prev" title="Coding and Compiling a Heterogeneous Program" href="../CodingAndCompiling/CodingAndCompiling.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../TheThreeMusketeers/TheThreeMusketeers.html" title="The Three Musketeers"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../CodingAndCompiling/CodingAndCompiling.html" title="Coding and Compiling a Heterogeneous Program"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">Heterogeneous Computing</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="activities">
<h1>Activities<a class="headerlink" href="#activities" title="Permalink to this headline">¶</a></h1>
<p>In this chapter, we are going to look at two problems, one is vector-matrix multiplication, and the other is matrix-matrix multiplication. We chose these problems because they are relatively easy to decompose, and not complicated.</p>
<div class="section" id="activity-2-vector-matrix-multiplication">
<h2>Activity 2: Vector Matrix Multiplication<a class="headerlink" href="#activity-2-vector-matrix-multiplication" title="Permalink to this headline">¶</a></h2>
<p>In this activity, we are going to compute vector-matrix multiplication using Hybrid MPI and CUDA. You might already see this problem before in the MPI module. If so, it will be not much different. The basic idea is we would like to split the rows of the matrix, and ask the master to send some rows of the matrix and entire input vector to each worker. We then ask each worker to receive messages from the master, and each worker will call the CUDA function to do computation on their own GPU. Basically, on the GPU each thread will take care of a multiplication between an element of the matrix, and an element of the vector. This obviously would speed up our computation.</p>
<div class="highlight-c"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48</pre></div></td><td class="code"><div class="highlight"><pre><span class="cp">#include &lt;stdio.h&gt;</span>
<span class="cp">#include &lt;cuda.h&gt;</span>

<span class="cm">/* kernel function for computation on the GPU */</span>
<span class="n">__global__</span> <span class="kt">void</span> <span class="nf">kernel</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">A</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="kt">int</span> <span class="n">block_size</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">tid</span> <span class="o">=</span> <span class="n">blockIdx</span><span class="p">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">blockDim</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">entry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">width</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">entry</span> <span class="o">+=</span> <span class="n">A</span><span class="p">[</span><span class="n">tid</span> <span class="o">*</span> <span class="n">width</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="n">y</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* function on the host, CPU */</span>
<span class="k">extern</span> <span class="s">&quot;C&quot;</span> <span class="kt">void</span> <span class="n">run_kernel</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">A</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="kt">int</span> <span class="n">block_size</span><span class="p">)</span> <span class="p">{</span>

    <span class="cm">/* the size of the matrix and the vector */</span>
    <span class="kt">int</span> <span class="n">matrix_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="o">*</span> <span class="n">width</span> <span class="o">*</span> <span class="n">width</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">vector_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="o">*</span> <span class="n">width</span><span class="p">;</span>

    <span class="cm">/* Pointes array on GPU */</span>
    <span class="kt">int</span> <span class="o">*</span><span class="n">dev_A</span><span class="p">,</span> <span class="o">*</span><span class="n">dev_x</span><span class="p">,</span> <span class="o">*</span><span class="n">dev_y</span><span class="p">;</span>

    <span class="cm">/* Allocate memory on GPU */</span>
    <span class="n">cudaMalloc</span><span class="p">((</span><span class="kt">void</span><span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dev_A</span><span class="p">,</span> <span class="n">matrix_size</span><span class="p">);</span>
    <span class="n">cudaMalloc</span><span class="p">((</span><span class="kt">void</span><span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dev_x</span><span class="p">,</span> <span class="n">vector_size</span><span class="p">);</span>
    <span class="n">cudaMalloc</span><span class="p">((</span><span class="kt">void</span><span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">dev_y</span><span class="p">,</span> <span class="n">vector_size</span><span class="p">);</span>

    <span class="cm">/* Copy matrix and vector from CPU to GPU */</span>
    <span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">dev_A</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">matrix_size</span><span class="p">,</span> <span class="n">cudaMemcpyHostToDevice</span><span class="p">);</span>
    <span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">dev_x</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">vector_size</span><span class="p">,</span> <span class="n">cudaMemcpyHostToDevice</span><span class="p">);</span>

    <span class="cm">/* Initializing the grid size and block size */</span>
    <span class="n">dim3</span> <span class="n">dimGrid</span><span class="p">(</span><span class="n">width</span><span class="o">/</span><span class="n">block_size</span><span class="p">,</span> <span class="n">width</span><span class="o">/</span><span class="n">block_size</span><span class="p">);</span>
    <span class="n">dim3</span> <span class="n">dimBlock</span><span class="p">(</span><span class="n">block_size</span><span class="p">,</span> <span class="n">block_size</span><span class="p">);</span>

    <span class="cm">/* Running the kernel function */</span>
    <span class="n">kernel</span><span class="o">&lt;&lt;&lt;</span><span class="n">dimGrid</span><span class="p">,</span> <span class="n">dimBlock</span><span class="o">&gt;&gt;&gt;</span><span class="p">(</span><span class="n">dev_A</span><span class="p">,</span> <span class="n">dev_x</span><span class="p">,</span> <span class="n">dev_y</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">block_size</span><span class="p">);</span>

    <span class="cm">/* Copy the output vector from GPU to CPU */</span>
    <span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">dev_y</span><span class="p">,</span> <span class="n">vector_size</span><span class="p">,</span> <span class="n">cudaMemcpyDeviceToHost</span><span class="p">);</span>

    <span class="cm">/* Free memory on GPU */</span>
    <span class="n">cudaFree</span><span class="p">(</span><span class="n">dev_A</span><span class="p">);</span>
    <span class="n">cudaFree</span><span class="p">(</span><span class="n">dev_x</span><span class="p">);</span>
    <span class="n">cudaFree</span><span class="p">(</span><span class="n">dev_y</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<div class="highlight-c"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114</pre></div></td><td class="code"><div class="highlight"><pre><span class="cp">#include &quot;mpi.h&quot;</span>
<span class="cp">#include &lt;stdio.h&gt;</span>

<span class="cp">#define COLS 24         </span><span class="cm">/* number of columns of the matrix */</span><span class="cp"></span>
<span class="cp">#define ROWS 24         </span><span class="cm">/* number of rows of the matrix */</span><span class="cp"></span>
<span class="cp">#define MASTER 0        </span><span class="cm">/* master has rank 0 */</span><span class="cp"></span>
<span class="cp">#define FROM_MASTER 1   </span><span class="cm">/* message sent from master */</span><span class="cp"></span>
<span class="cp">#define FROM_WORKER 2   </span><span class="cm">/* message sent from worker */</span><span class="cp"></span>
<span class="cp">#define BLOCK_SIZE 12   </span><span class="cm">/* number of threads in a block */</span><span class="cp"></span>
<span class="cp">#define MAX_NAME 80     </span><span class="cm">/* length of character for naming a node */</span><span class="cp"></span>

<span class="cm">/* Declaring CUDA function for vector-matrix multiplication */</span>
<span class="kt">void</span> <span class="n">run_kernel</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">A</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="kt">int</span> <span class="n">block_size</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[]</span> <span class="p">)</span> <span class="p">{</span>

    <span class="kt">int</span> <span class="n">nprocs</span><span class="p">,</span>         <span class="cm">/* number of processes */</span>
        <span class="n">rank</span><span class="p">,</span>           <span class="cm">/* rank of a process */</span>
        <span class="n">len</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

    <span class="kt">int</span> <span class="n">averow</span><span class="p">,</span>         <span class="cm">/* average rows to be sent to each worker */</span>
        <span class="n">extra</span><span class="p">,</span>          <span class="cm">/* extra rows to be sent to some workers */</span>
        <span class="n">offset</span><span class="p">,</span>         <span class="cm">/* starting position of row to be sent */</span>
        <span class="n">dest</span><span class="p">,</span>           <span class="cm">/* rank of the destination process */</span>
        <span class="n">numworkers</span><span class="p">,</span>     <span class="cm">/* number of workers */</span>
        <span class="n">mtype</span><span class="p">,</span>          <span class="cm">/* message type */</span>
        <span class="n">source</span><span class="p">,</span>         <span class="cm">/* rank of the source process */</span>
        <span class="n">rows</span><span class="p">;</span>           <span class="cm">/* number of rows to be sent to a worker */</span>

    <span class="kt">int</span> <span class="n">matrix</span><span class="p">[</span><span class="n">ROWS</span><span class="p">][</span><span class="n">COLS</span><span class="p">];</span>     <span class="cm">/* matrix for the multiplication */</span>
    <span class="kt">int</span> <span class="n">vector</span><span class="p">[</span><span class="n">ROWS</span><span class="p">];</span>           <span class="cm">/* vector for the multiplication */</span>
    <span class="kt">int</span> <span class="n">result</span><span class="p">[</span><span class="n">ROWS</span><span class="p">];</span>           <span class="cm">/* output vector */</span>

    <span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="n">MAX_NAME</span><span class="p">];</span>        <span class="cm">/* char array for storing name of a process */</span>

    <span class="n">MPI_Status</span> <span class="n">status</span><span class="p">;</span>          <span class="cm">/* status for receiving message from MPI_Send */</span>

    <span class="cm">/* Initialize MPI execution environment */</span>
    <span class="n">MPI_Init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">argc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">argv</span><span class="p">);</span>
    <span class="n">MPI_Comm_rank</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rank</span><span class="p">);</span>
    <span class="n">MPI_Comm_size</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nprocs</span><span class="p">);</span>

    <span class="n">MPI_Get_processor_name</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>

    <span class="cm">/******************************* Master ***************************/</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="cm">/* Initialize Matrix and Vector */</span>
        <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ROWS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">vector</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
            <span class="k">for</span><span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">COLS</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">matrix</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="n">numworkers</span> <span class="o">=</span> <span class="n">nprocs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

        <span class="cm">/* divide the number of rows for each worker */</span>
        <span class="n">averow</span> <span class="o">=</span> <span class="n">ROWS</span><span class="o">/</span><span class="n">numworkers</span><span class="p">;</span>
        <span class="n">extra</span> <span class="o">=</span> <span class="n">ROWS</span><span class="o">%</span><span class="n">numworkers</span><span class="p">;</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">mtype</span> <span class="o">=</span> <span class="n">FROM_MASTER</span><span class="p">;</span>

        <span class="cm">/* Master sends smaller task to each worker */</span>
        <span class="k">for</span><span class="p">(</span><span class="n">dest</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">dest</span> <span class="o">&lt;=</span> <span class="n">numworkers</span><span class="p">;</span> <span class="n">dest</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="p">(</span><span class="n">dest</span> <span class="o">&lt;=</span> <span class="n">extra</span><span class="p">)</span> <span class="o">?</span> <span class="n">averow</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">:</span> <span class="n">averow</span><span class="p">;</span>
            <span class="n">MPI_Send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">offset</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MPI_INT</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">mtype</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">);</span>
            <span class="n">MPI_Send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rows</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MPI_INT</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">mtype</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">);</span>
            <span class="n">MPI_Send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">matrix</span><span class="p">[</span><span class="n">offset</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">rows</span> <span class="o">*</span> <span class="n">COLS</span><span class="p">,</span> <span class="n">MPI_INT</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">mtype</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">);</span>
            <span class="n">MPI_Send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vector</span><span class="p">,</span> <span class="n">ROWS</span><span class="p">,</span> <span class="n">MPI_INT</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">mtype</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">);</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Master sent elements %d to %d to rank %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">rows</span><span class="p">,</span> <span class="n">dest</span><span class="p">);</span>
            <span class="n">offset</span> <span class="o">+=</span> <span class="n">rows</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="cm">/* Master receives the output from each worker*/</span>
        <span class="n">mtype</span> <span class="o">=</span> <span class="n">FROM_WORKER</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">numworkers</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
             <span class="n">source</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
             <span class="n">MPI_Recv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">offset</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MPI_INT</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span><span class="n">mtype</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
             <span class="n">MPI_Recv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rows</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MPI_INT</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">mtype</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
             <span class="n">MPI_Recv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result</span><span class="p">[</span><span class="n">offset</span><span class="p">],</span> <span class="n">rows</span><span class="p">,</span> <span class="n">MPI_INT</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">mtype</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
             <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Received results from task %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">source</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="cm">/* Master prints results */</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ROWS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;The element of output vector is: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="cm">/************************************** Workers *************************************/</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">rank</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">mtype</span> <span class="o">=</span> <span class="n">FROM_MASTER</span><span class="p">;</span>
        <span class="cm">/* Each worker receives messages sent from the master*/</span>
        <span class="n">MPI_Recv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">offset</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MPI_INT</span><span class="p">,</span> <span class="n">MASTER</span><span class="p">,</span> <span class="n">mtype</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
        <span class="n">MPI_Recv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rows</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MPI_INT</span><span class="p">,</span> <span class="n">MASTER</span><span class="p">,</span> <span class="n">mtype</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
        <span class="n">MPI_Recv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">matrix</span><span class="p">,</span> <span class="n">rows</span><span class="o">*</span><span class="n">COLS</span><span class="p">,</span> <span class="n">MPI_INT</span><span class="p">,</span> <span class="n">MASTER</span><span class="p">,</span> <span class="n">mtype</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
        <span class="n">MPI_Recv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vector</span><span class="p">,</span> <span class="n">ROWS</span><span class="p">,</span> <span class="n">MPI_INT</span><span class="p">,</span> <span class="n">MASTER</span><span class="p">,</span> <span class="n">mtype</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Worker rank %d, %s receives the messages</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>

        <span class="cm">/* use CUDA function to compute the the vector-matrix multiplication for each worker */</span>
        <span class="n">run_kernel</span><span class="p">(</span><span class="o">*</span><span class="n">matrix</span><span class="p">,</span> <span class="n">vector</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">ROWS</span><span class="p">,</span> <span class="n">BLOCK_SIZE</span><span class="p">);</span>

        <span class="cm">/* Each worker sends the result back to the master */</span>
        <span class="n">mtype</span> <span class="o">=</span> <span class="n">FROM_WORKER</span><span class="p">;</span>
        <span class="n">MPI_Send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">offset</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MPI_INT</span><span class="p">,</span> <span class="n">MASTER</span><span class="p">,</span> <span class="n">mtype</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">);</span>
        <span class="n">MPI_Send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rows</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MPI_INT</span><span class="p">,</span> <span class="n">MASTER</span><span class="p">,</span> <span class="n">mtype</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">);</span>
        <span class="n">MPI_Send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">MPI_INT</span><span class="p">,</span> <span class="n">MASTER</span><span class="p">,</span> <span class="n">mtype</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Worker rank %d, %s sends the result to master </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rank</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/* Terminate the MPI execution environment */</span>
    <span class="n">MPI_Finalize</span><span class="p">();</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="activity-3-matrix-multiplication">
<h2>Activity 3: Matrix Multiplication<a class="headerlink" href="#activity-3-matrix-multiplication" title="Permalink to this headline">¶</a></h2>
<p>In this activity, we are going to compute matrix-matrix multiplication using Hybrid MPI and CUDA. The basic idea is we want to split the rows of the first matrix, and ask the master to send some rows of the first matrix and the entire second matrix to each worker. We then ask each worker to receive messages sent from the master, and each worker will call the CUDA function to do computation on their own GPU. On the GPU each thread will take care of a multiplication between an element of the first matrix, and an element of the second matrix.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This is not the most efficient method of doing matrix-matrix multiplication by using CUDA and MPI because when the second matrix gets too large, a progammer may not be able to send it to each worker. Furthermore, we can improve the kernel function to be more effective when working with CUDA.</p>
</div>
<p>First let&#8217;s look at the kernel function in the CUDA program.</p>
<div class="highlight-c"><div class="highlight"><pre><span class="cm">/* kernel function */</span>
<span class="n">__global__</span> <span class="kt">void</span> <span class="nf">MatrixKernel</span><span class="p">(</span><span class="kt">float</span> <span class="o">*</span><span class="n">dM</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="n">dN</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="n">dP</span><span class="p">,</span> <span class="kt">int</span> <span class="n">width</span><span class="p">)</span> <span class="p">{</span>

        <span class="cm">/* calculate the row index of the dP element and M */</span>
        <span class="kt">int</span> <span class="n">row</span> <span class="o">=</span> <span class="n">blockIdx</span><span class="p">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">blockDim</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
        <span class="cm">/* calculate the column index of dP element and N */</span>
        <span class="kt">int</span> <span class="n">col</span> <span class="o">=</span> <span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">blockDim</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>

        <span class="kt">float</span> <span class="n">pvalue</span> <span class="o">=</span> <span class="mf">0.0f</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">width</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="kt">float</span> <span class="n">M_elem</span> <span class="o">=</span> <span class="n">dM</span><span class="p">[</span><span class="n">row</span> <span class="o">*</span> <span class="n">width</span> <span class="o">+</span> <span class="n">k</span><span class="p">];</span>
                <span class="kt">float</span> <span class="n">N_elem</span> <span class="o">=</span> <span class="n">dN</span><span class="p">[</span><span class="n">k</span> <span class="o">*</span> <span class="n">width</span> <span class="o">+</span> <span class="n">col</span><span class="p">];</span>
                <span class="n">pvalue</span> <span class="o">+=</span> <span class="n">M_elem</span> <span class="o">*</span> <span class="n">N_elem</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">dP</span><span class="p">[</span><span class="n">row</span> <span class="o">*</span> <span class="n">width</span> <span class="o">+</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">pvalue</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>We use 2-dimensional blocks and threads for matrices. Each thread calculate an element of the result matrix.</p>
<p>Then we need to have a function that uses the kernel function on the host. This function is to allocate memory for the matrices on the device, copy matrices from host to device, compute the matrix multiplication, and copy the result matrix from device to the host. This function will be called in the MPI program.</p>
<div class="highlight-c"><div class="highlight"><pre><span class="cm">/* function that you will call in mpi code */</span>
<span class="k">extern</span> <span class="s">&quot;C&quot;</span> <span class="kt">void</span> <span class="n">MatrixMul</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span> <span class="n">M</span><span class="p">,</span> <span class="kt">float</span><span class="o">*</span> <span class="n">N</span><span class="p">,</span> <span class="kt">float</span><span class="o">*</span> <span class="n">P</span><span class="p">,</span> <span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="kt">int</span> <span class="n">block_size</span><span class="p">)</span> <span class="p">{</span>

        <span class="kt">int</span> <span class="n">matrix_size</span> <span class="o">=</span> <span class="n">width</span> <span class="o">*</span> <span class="n">width</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">);</span>
        <span class="kt">float</span> <span class="o">*</span><span class="n">dM</span><span class="p">,</span> <span class="o">*</span><span class="n">dN</span><span class="p">,</span> <span class="o">*</span><span class="n">dP</span><span class="p">;</span>

        <span class="c1">// Allocate and Load M and N to device memory</span>
        <span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dM</span><span class="p">,</span> <span class="n">matrix_size</span><span class="p">);</span>
        <span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">dM</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">matrix_size</span><span class="p">,</span> <span class="n">cudaMemcpyHostToDevice</span><span class="p">);</span>

        <span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dN</span><span class="p">,</span> <span class="n">matrix_size</span><span class="p">);</span>
        <span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">dN</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">matrix_size</span><span class="p">,</span> <span class="n">cudaMemcpyHostToDevice</span><span class="p">);</span>

        <span class="c1">// Allocate P on device</span>
        <span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dP</span><span class="p">,</span> <span class="n">matrix_size</span><span class="p">);</span>

        <span class="n">dim3</span> <span class="n">dimGrid</span><span class="p">(</span><span class="n">width</span><span class="o">/</span><span class="n">block_size</span><span class="p">,</span> <span class="n">width</span><span class="o">/</span><span class="n">block_size</span><span class="p">);</span>
        <span class="n">dim3</span> <span class="n">dimBlock</span><span class="p">(</span><span class="n">block_size</span><span class="p">,</span> <span class="n">block_size</span><span class="p">);</span>

        <span class="n">MatrixKernel</span><span class="o">&lt;&lt;&lt;</span><span class="n">dimGrid</span><span class="p">,</span> <span class="n">dimBlock</span><span class="o">&gt;&gt;&gt;</span><span class="p">(</span><span class="n">dM</span><span class="p">,</span> <span class="n">dN</span><span class="p">,</span> <span class="n">dP</span><span class="p">,</span> <span class="n">width</span><span class="p">);</span>

        <span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">dP</span><span class="p">,</span> <span class="n">matrix_size</span><span class="p">,</span> <span class="n">cudaMemcpyDeviceToHost</span><span class="p">);</span>

        <span class="n">cudaFree</span><span class="p">(</span><span class="n">dP</span><span class="p">);</span>
        <span class="n">cudaFree</span><span class="p">(</span><span class="n">dM</span><span class="p">);</span>
        <span class="n">cudaFree</span><span class="p">(</span><span class="n">dN</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-c"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45</pre></div></td><td class="code"><div class="highlight"><pre><span class="cp">#include &lt;cuda.h&gt;</span>
<span class="cp">#include &lt;stdio.h&gt;</span>

<span class="cm">/* kernel function */</span>
<span class="n">__global__</span> <span class="kt">void</span> <span class="nf">MatrixKernel</span><span class="p">(</span><span class="kt">float</span> <span class="o">*</span><span class="n">dM</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="n">dN</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="n">dP</span><span class="p">,</span> <span class="kt">int</span> <span class="n">width</span><span class="p">)</span> <span class="p">{</span>

    <span class="kt">int</span> <span class="n">row</span> <span class="o">=</span> <span class="n">blockIdx</span><span class="p">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">blockDim</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">threadIdx</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">col</span> <span class="o">=</span> <span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">blockDim</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>

    <span class="kt">float</span> <span class="n">pvalue</span> <span class="o">=</span> <span class="mf">0.0f</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">width</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">float</span> <span class="n">M_elem</span> <span class="o">=</span> <span class="n">dM</span><span class="p">[</span><span class="n">row</span> <span class="o">*</span> <span class="n">width</span> <span class="o">+</span> <span class="n">k</span><span class="p">];</span>
        <span class="kt">float</span> <span class="n">N_elem</span> <span class="o">=</span> <span class="n">dN</span><span class="p">[</span><span class="n">k</span> <span class="o">*</span> <span class="n">width</span> <span class="o">+</span> <span class="n">col</span><span class="p">];</span>
        <span class="n">pvalue</span> <span class="o">+=</span> <span class="n">M_elem</span> <span class="o">*</span> <span class="n">N_elem</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">dP</span><span class="p">[</span><span class="n">row</span> <span class="o">*</span> <span class="n">width</span> <span class="o">+</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">pvalue</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* function that you will call in mpi code */</span>
<span class="k">extern</span> <span class="s">&quot;C&quot;</span> <span class="kt">void</span> <span class="n">MatrixMul</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span> <span class="n">M</span><span class="p">,</span> <span class="kt">float</span><span class="o">*</span> <span class="n">N</span><span class="p">,</span> <span class="kt">float</span><span class="o">*</span> <span class="n">P</span><span class="p">,</span> <span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="kt">int</span> <span class="n">block_size</span><span class="p">)</span> <span class="p">{</span>

    <span class="kt">int</span> <span class="n">matrix_size</span> <span class="o">=</span> <span class="n">width</span> <span class="o">*</span> <span class="n">width</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">float</span><span class="p">);</span>
    <span class="kt">float</span> <span class="o">*</span><span class="n">dM</span><span class="p">,</span> <span class="o">*</span><span class="n">dN</span><span class="p">,</span> <span class="o">*</span><span class="n">dP</span><span class="p">;</span>

    <span class="c1">// Allocate and Load M and N to device memory</span>
    <span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dM</span><span class="p">,</span> <span class="n">matrix_size</span><span class="p">);</span>
    <span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">dM</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">matrix_size</span><span class="p">,</span> <span class="n">cudaMemcpyHostToDevice</span><span class="p">);</span>

    <span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dN</span><span class="p">,</span> <span class="n">matrix_size</span><span class="p">);</span>
    <span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">dN</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">matrix_size</span><span class="p">,</span> <span class="n">cudaMemcpyHostToDevice</span><span class="p">);</span>

    <span class="c1">// Allocate P on device</span>
    <span class="n">cudaMalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dP</span><span class="p">,</span> <span class="n">matrix_size</span><span class="p">);</span>

    <span class="n">dim3</span> <span class="n">dimGrid</span><span class="p">(</span><span class="n">width</span><span class="o">/</span><span class="n">block_size</span><span class="p">,</span> <span class="n">width</span><span class="o">/</span><span class="n">block_size</span><span class="p">);</span>
    <span class="n">dim3</span> <span class="n">dimBlock</span><span class="p">(</span><span class="n">block_size</span><span class="p">,</span> <span class="n">block_size</span><span class="p">);</span>

    <span class="n">MatrixKernel</span><span class="o">&lt;&lt;&lt;</span><span class="n">dimGrid</span><span class="p">,</span> <span class="n">dimBlock</span><span class="o">&gt;&gt;&gt;</span><span class="p">(</span><span class="n">dM</span><span class="p">,</span> <span class="n">dN</span><span class="p">,</span> <span class="n">dP</span><span class="p">,</span> <span class="n">width</span><span class="p">);</span>

    <span class="n">cudaMemcpy</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">dP</span><span class="p">,</span> <span class="n">matrix_size</span><span class="p">,</span> <span class="n">cudaMemcpyDeviceToHost</span><span class="p">);</span>

    <span class="n">cudaFree</span><span class="p">(</span><span class="n">dP</span><span class="p">);</span>
    <span class="n">cudaFree</span><span class="p">(</span><span class="n">dM</span><span class="p">);</span>
    <span class="n">cudaFree</span><span class="p">(</span><span class="n">dN</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>Now we can look at the MPI program. This MPI program is a revised version of the Matrix Mutiplication MPI that was written by Blaise Barney. First we need to initialize the MPI execution environment, define the size of MPI_COMM_WORLD, and give a unique rank to each process. Then we ask the master to initialize the input matrices,  divide these matrices, and send their pieces to each worker.</p>
<div class="highlight-c"><div class="highlight"><pre>    <span class="cm">/**************************** master task ************************************/</span>
<span class="k">if</span> <span class="p">(</span><span class="n">taskid</span> <span class="o">==</span> <span class="n">MASTER</span><span class="p">)</span> <span class="p">{</span>

            <span class="cm">/* Initializing both matrices on master node */</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ROW_A</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
                    <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">COL_A</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
                            <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">COL_A</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
                    <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">COL_B</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
                            <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

            <span class="cm">/* Computing the average row and extra row for each process */</span>
            <span class="n">averow</span> <span class="o">=</span> <span class="n">ROW_A</span><span class="o">/</span><span class="n">numworkers</span><span class="p">;</span>
            <span class="n">extra</span> <span class="o">=</span> <span class="n">ROW_A</span><span class="o">%</span><span class="n">numworkers</span><span class="p">;</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">mtype</span> <span class="o">=</span> <span class="n">FROM_MASTER</span><span class="p">;</span>

            <span class="cm">/* Distributing the task to each worker */</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">dest</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">dest</span> <span class="o">&lt;=</span> <span class="n">numworkers</span><span class="p">;</span> <span class="n">dest</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">rows</span> <span class="o">=</span> <span class="p">(</span><span class="n">dest</span> <span class="o">&lt;=</span> <span class="n">extra</span><span class="p">)</span> <span class="o">?</span> <span class="n">averow</span><span class="o">+</span><span class="mi">1</span> <span class="o">:</span> <span class="n">averow</span><span class="p">;</span>
                    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Sending %d rows to task %d offset = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
                    <span class="n">MPI_Send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">offset</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MPI_INT</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">mtype</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">);</span>
                    <span class="n">MPI_Send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rows</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MPI_INT</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">mtype</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">);</span>
                    <span class="n">MPI_Send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="p">[</span><span class="n">offset</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">rows</span><span class="o">*</span><span class="n">COL_A</span><span class="p">,</span> <span class="n">MPI_FLOAT</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">mtype</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">);</span>
                    <span class="n">MPI_Send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b</span><span class="p">,</span> <span class="n">COL_A</span><span class="o">*</span><span class="n">COL_B</span><span class="p">,</span> <span class="n">MPI_FLOAT</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">mtype</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">);</span>
                    <span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">rows</span><span class="p">;</span>
            <span class="p">}</span>
    <span class="p">}</span>
</pre></div>
</div>
<p>We need to ask all workers to receive the messages sent from the master. Then we want each worker to call the host function from the CUDA program to compute their matrix multiplication. After having computed their multiplication, each worker needs to send their result back to the master.</p>
<div class="highlight-c"><div class="highlight"><pre>    <span class="cm">/**************************** worker task ************************************/</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">taskid</span> <span class="o">&gt;</span> <span class="n">MASTER</span><span class="p">)</span> <span class="p">{</span>

            <span class="cm">/* Each receives task from master*/</span>
            <span class="n">mtype</span> <span class="o">=</span> <span class="n">FROM_MASTER</span><span class="p">;</span>
            <span class="n">MPI_Recv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">offset</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MPI_INT</span><span class="p">,</span> <span class="n">MASTER</span><span class="p">,</span> <span class="n">mtype</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
            <span class="n">MPI_Recv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rows</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MPI_INT</span><span class="p">,</span> <span class="n">MASTER</span><span class="p">,</span> <span class="n">mtype</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
            <span class="n">MPI_Recv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="p">,</span> <span class="n">rows</span><span class="o">*</span><span class="n">COL_A</span><span class="p">,</span> <span class="n">MPI_FLOAT</span><span class="p">,</span> <span class="n">MASTER</span><span class="p">,</span> <span class="n">mtype</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
            <span class="n">MPI_Recv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b</span><span class="p">,</span> <span class="n">COL_A</span><span class="o">*</span><span class="n">COL_B</span><span class="p">,</span> <span class="n">MPI_FLOAT</span><span class="p">,</span> <span class="n">MASTER</span><span class="p">,</span> <span class="n">mtype</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>

            <span class="cm">/* Calling function from CUDA. Each worker computes on their GPU */</span>
            <span class="n">MatrixMul</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">*</span><span class="n">b</span><span class="p">,</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="n">WIDTH</span><span class="p">,</span> <span class="mi">128</span><span class="p">);</span>

            <span class="cm">/* Each worker sends result back to the master */</span>
            <span class="n">mtype</span> <span class="o">=</span> <span class="n">FROM_WORKER</span><span class="p">;</span>
            <span class="n">MPI_Send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">offset</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MPI_INT</span><span class="p">,</span> <span class="n">MASTER</span><span class="p">,</span> <span class="n">mtype</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">);</span>
            <span class="n">MPI_Send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rows</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MPI_INT</span><span class="p">,</span> <span class="n">MASTER</span><span class="p">,</span> <span class="n">mtype</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">);</span>
            <span class="n">MPI_Send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="n">rows</span><span class="o">*</span><span class="n">COL_B</span><span class="p">,</span> <span class="n">MPI_FLOAT</span><span class="p">,</span> <span class="n">MASTER</span><span class="p">,</span> <span class="n">mtype</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Finally we need to ask the master to receive the messages sent from each worker, and prints the result matrix.</p>
<div class="highlight-c"><div class="highlight"><pre><span class="cm">/* Receive results from worker tasks */</span>
<span class="n">mtype</span> <span class="o">=</span> <span class="n">FROM_WORKER</span><span class="p">;</span>
<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">numworkers</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
        <span class="n">MPI_Recv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">offset</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MPI_INT</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">mtype</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
        <span class="n">MPI_Recv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rows</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MPI_INT</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">mtype</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
        <span class="n">MPI_Recv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="p">[</span><span class="n">offset</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">rows</span><span class="o">*</span><span class="n">COL_B</span><span class="p">,</span> <span class="n">MPI_FLOAT</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">mtype</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Received results from task %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">source</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Master prints results */</span>
<span class="n">printf</span><span class="p">(</span><span class="s">&quot;******************************************************</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="n">printf</span><span class="p">(</span><span class="s">&quot;Result Matrix:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ROW_A</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">COL_B</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%6.2f   &quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]);</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-c"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131</pre></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*******************************************************************</span>
<span class="cm">* File: mpi.c (The Heterogeneous cuda and mpi)</span>
<span class="cm">* Description:</span>
<span class="cm">*       This program is the hybrid of cuda and mpi to calculate</span>
<span class="cm">*       matrix multiplication. This is very similar to matrix</span>
<span class="cm">*       multiplication mpi version. But it has to call function</span>
<span class="cm">*       from cuda.cu and then each node uses that function for each</span>
<span class="cm">*       computation.</span>
<span class="cm">* NOTE: This code is a modified version of mpi_mm.c by Blaise Barney.</span>
<span class="cm">*******************************************************************/</span>

<span class="cp">#include &quot;mpi.h&quot;</span>
<span class="cp">#include &lt;stdio.h&gt;</span>
<span class="cp">#include &lt;stdlib.h&gt;</span>

<span class="cp">#define ROW_A 32               </span><span class="cm">/* number of rows in matrix A */</span><span class="cp"></span>
<span class="cp">#define COL_A 12               </span><span class="cm">/* number of columns in matrix A */</span><span class="cp"></span>
<span class="cp">#define COL_B 32               </span><span class="cm">/* number of columns in matrix B */</span><span class="cp"></span>
<span class="cp">#define MASTER 0               </span><span class="cm">/* taskid of the master node */</span><span class="cp"></span>
<span class="cp">#define FROM_MASTER 1          </span><span class="cm">/* setting a message type */</span><span class="cp"></span>
<span class="cp">#define FROM_WORKER 2          </span><span class="cm">/* setting a message type */</span><span class="cp"></span>
<span class="cp">#define WIDTH 32               </span><span class="cm">/* width of the matrix */</span><span class="cp"></span>

<span class="cm">/* declaring function from cuda*/</span>
<span class="kt">void</span> <span class="n">MatrixMul</span><span class="p">(</span><span class="kt">float</span> <span class="o">*</span><span class="n">dM</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="n">dN</span><span class="p">,</span> <span class="kt">float</span> <span class="o">*</span><span class="n">dP</span><span class="p">,</span> <span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="kt">int</span> <span class="n">block_size</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">main</span> <span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>

    <span class="kt">int</span> <span class="n">numtasks</span><span class="p">,</span>              <span class="cm">/* number of tasks in partition */</span>
        <span class="n">rank</span><span class="p">,</span>                  <span class="cm">/* a task identifier */</span>
        <span class="n">numworkers</span><span class="p">,</span>            <span class="cm">/* number of worker tasks */</span>
        <span class="n">source</span><span class="p">,</span>                <span class="cm">/* task id of message source */</span>
        <span class="n">dest</span><span class="p">,</span>                  <span class="cm">/* task id of message destination */</span>
        <span class="n">mtype</span><span class="p">,</span>                 <span class="cm">/* message type */</span>
        <span class="n">rows</span><span class="p">,</span>                  <span class="cm">/* rows of matrix A sent to each worker */</span>
        <span class="n">averow</span><span class="p">,</span> <span class="n">extra</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="cm">/* used to determine rows sent to each worker */</span>
        <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>           <span class="cm">/* variables for loops */</span>

    <span class="kt">float</span> <span class="n">a</span><span class="p">[</span><span class="n">ROW_A</span><span class="p">][</span><span class="n">COL_A</span><span class="p">],</span>           <span class="cm">/* matrix A for multiplication */</span>
          <span class="n">b</span><span class="p">[</span><span class="n">COL_A</span><span class="p">][</span><span class="n">COL_B</span><span class="p">],</span>           <span class="cm">/* matrix B for multiplication */</span>
          <span class="n">c</span><span class="p">[</span><span class="n">ROW_A</span><span class="p">][</span><span class="n">COL_B</span><span class="p">];</span>           <span class="cm">/* result matrix C */</span>

    <span class="n">MPI_Status</span> <span class="n">status</span><span class="p">;</span>         <span class="cm">/* the status for receiving the result */</span>


    <span class="cm">/*Initializing MPI execution environment*/</span>
    <span class="n">MPI_Init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">argc</span><span class="p">,</span><span class="o">&amp;</span><span class="n">argv</span><span class="p">);</span>
    <span class="n">MPI_Comm_rank</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">taskid</span><span class="p">);</span>
    <span class="n">MPI_Comm_size</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">numtasks</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">numtasks</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Need at least two MPI tasks. Quitting...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="n">MPI_Abort</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">numworkers</span> <span class="o">=</span> <span class="n">numtasks</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>    <span class="cm">/* number of workers */</span>

    <span class="cm">/**************************** master task ************************************/</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">taskid</span> <span class="o">==</span> <span class="n">MASTER</span><span class="p">)</span> <span class="p">{</span>

        <span class="cm">/* Initializing both matrices on master node */</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ROW_A</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">COL_A</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
                <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">COL_A</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">COL_B</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
                <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

        <span class="cm">/* Computing the average row and extra row for each process */</span>
        <span class="n">averow</span> <span class="o">=</span> <span class="n">ROW_A</span><span class="o">/</span><span class="n">numworkers</span><span class="p">;</span>
        <span class="n">extra</span> <span class="o">=</span> <span class="n">ROW_A</span><span class="o">%</span><span class="n">numworkers</span><span class="p">;</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">mtype</span> <span class="o">=</span> <span class="n">FROM_MASTER</span><span class="p">;</span>

        <span class="cm">/* Distributing the task to each worker */</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">dest</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">dest</span> <span class="o">&lt;=</span> <span class="n">numworkers</span><span class="p">;</span> <span class="n">dest</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="p">(</span><span class="n">dest</span> <span class="o">&lt;=</span> <span class="n">extra</span><span class="p">)</span> <span class="o">?</span> <span class="n">averow</span><span class="o">+</span><span class="mi">1</span> <span class="o">:</span> <span class="n">averow</span><span class="p">;</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Sending %d rows to task %d offset = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
            <span class="n">MPI_Send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">offset</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MPI_INT</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">mtype</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">);</span>
            <span class="n">MPI_Send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rows</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MPI_INT</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">mtype</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">);</span>
            <span class="n">MPI_Send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="p">[</span><span class="n">offset</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">rows</span><span class="o">*</span><span class="n">COL_A</span><span class="p">,</span> <span class="n">MPI_FLOAT</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">mtype</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">);</span>
            <span class="n">MPI_Send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b</span><span class="p">,</span> <span class="n">COL_A</span><span class="o">*</span><span class="n">COL_B</span><span class="p">,</span> <span class="n">MPI_FLOAT</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">mtype</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">);</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">rows</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="cm">/* Receive results from worker tasks */</span>
        <span class="n">mtype</span> <span class="o">=</span> <span class="n">FROM_WORKER</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">numworkers</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">source</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
            <span class="n">MPI_Recv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">offset</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MPI_INT</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">mtype</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
            <span class="n">MPI_Recv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rows</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MPI_INT</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">mtype</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
            <span class="n">MPI_Recv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="p">[</span><span class="n">offset</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">rows</span><span class="o">*</span><span class="n">COL_B</span><span class="p">,</span> <span class="n">MPI_FLOAT</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">mtype</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Received results from task %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">source</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="cm">/* Master prints results */</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;******************************************************</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Result Matrix:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ROW_A</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">COL_B</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
                 <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%6.2f   &quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]);</span>
        <span class="p">}</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">******************************************************</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;Done.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/**************************** worker task ************************************/</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">taskid</span> <span class="o">&gt;</span> <span class="n">MASTER</span><span class="p">)</span> <span class="p">{</span>

        <span class="cm">/* Each receives task from master*/</span>
        <span class="n">mtype</span> <span class="o">=</span> <span class="n">FROM_MASTER</span><span class="p">;</span>
        <span class="n">MPI_Recv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">offset</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MPI_INT</span><span class="p">,</span> <span class="n">MASTER</span><span class="p">,</span> <span class="n">mtype</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
        <span class="n">MPI_Recv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rows</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MPI_INT</span><span class="p">,</span> <span class="n">MASTER</span><span class="p">,</span> <span class="n">mtype</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
        <span class="n">MPI_Recv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="p">,</span> <span class="n">rows</span><span class="o">*</span><span class="n">COL_A</span><span class="p">,</span> <span class="n">MPI_FLOAT</span><span class="p">,</span> <span class="n">MASTER</span><span class="p">,</span> <span class="n">mtype</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
        <span class="n">MPI_Recv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b</span><span class="p">,</span> <span class="n">COL_A</span><span class="o">*</span><span class="n">COL_B</span><span class="p">,</span> <span class="n">MPI_FLOAT</span><span class="p">,</span> <span class="n">MASTER</span><span class="p">,</span> <span class="n">mtype</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>

        <span class="cm">/* Calling function from CUDA. Each worker computes on their GPU */</span>
        <span class="n">MatrixMul</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">*</span><span class="n">b</span><span class="p">,</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="n">WIDTH</span><span class="p">,</span> <span class="mi">128</span><span class="p">);</span>

        <span class="cm">/* Each worker sends result back to the master */</span>
        <span class="n">mtype</span> <span class="o">=</span> <span class="n">FROM_WORKER</span><span class="p">;</span>
        <span class="n">MPI_Send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">offset</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MPI_INT</span><span class="p">,</span> <span class="n">MASTER</span><span class="p">,</span> <span class="n">mtype</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">);</span>
        <span class="n">MPI_Send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rows</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MPI_INT</span><span class="p">,</span> <span class="n">MASTER</span><span class="p">,</span> <span class="n">mtype</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">);</span>
        <span class="n">MPI_Send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="n">rows</span><span class="o">*</span><span class="n">COL_B</span><span class="p">,</span> <span class="n">MPI_FLOAT</span><span class="p">,</span> <span class="n">MASTER</span><span class="p">,</span> <span class="n">mtype</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">);</span>
     <span class="p">}</span>

     <span class="cm">/* Terminate MPI execution environment */</span>
     <span class="n">MPI_Finalize</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Activities</a><ul>
<li><a class="reference internal" href="#activity-2-vector-matrix-multiplication">Activity 2: Vector Matrix Multiplication</a></li>
<li><a class="reference internal" href="#activity-3-matrix-multiplication">Activity 3: Matrix Multiplication</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="../CodingAndCompiling/CodingAndCompiling.html"
                        title="previous chapter">Coding and Compiling a Heterogeneous Program</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../TheThreeMusketeers/TheThreeMusketeers.html"
                        title="next chapter">The Three Musketeers</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/Activities/Activities.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../TheThreeMusketeers/TheThreeMusketeers.html" title="The Three Musketeers"
             >next</a> |</li>
        <li class="right" >
          <a href="../CodingAndCompiling/CodingAndCompiling.html" title="Coding and Compiling a Heterogeneous Program"
             >previous</a> |</li>
        <li><a href="../index.html">Heterogeneous Computing</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright This work is licensed under a Creative Commons Attribution-ShareAlike 3.0 Unported License.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>