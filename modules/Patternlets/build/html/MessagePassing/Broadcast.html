
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Broadcast &#8212; Parallel Patternlets</title>
    <link rel="stylesheet" href="../_static/csip.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Collective Communication" href="Reduction_Scatter_Gather.html" />
    <link rel="prev" title="Communication Patterns in MPI: Basic message passing" href="Communication.html" /> 
  </head>
  <body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="Reduction_Scatter_Gather.html" title="Collective Communication"
             accesskey="N">next</a></li>
        <li class="right" >
          <a href="Communication.html" title="Communication Patterns in MPI: Basic message passing"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Parallel Patternlets</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="MPI_Patternlets.html" accesskey="U">Message Passing Parallel Patternlets</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="broadcast">
<h1>Broadcast<a class="headerlink" href="#broadcast" title="Permalink to this headline">¶</a></h1>
<p>There is often a need for all the processes to share data
by ensuring that all of them have a copy of the same data in the memory
of their process. This form of communication is often done with
a <em>broadcast</em> from the master to all of the worker processes.</p>
<div class="section" id="broadcast-a-special-form-of-message-passing">
<h2>08. Broadcast: a special form of message passing<a class="headerlink" href="#broadcast-a-special-form-of-message-passing" title="Permalink to this headline">¶</a></h2>
<p><em>file: patternlets/MPI/08.broadcast/broadcast.c</em></p>
<p><em>Build inside 08.broadcast directory:</em></p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">broadcast</span>
</pre></div>
</div>
<p><em>Execute on the command line inside 08.broadcast directory:</em></p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">mpirun</span> <span class="o">-</span><span class="n">np</span> <span class="o">&lt;</span><span class="n">number</span> <span class="n">of</span> <span class="n">processes</span><span class="o">&gt;</span> <span class="o">./</span><span class="n">broadcast</span>
</pre></div>
</div>
<p>This example shows how a data item read from a file can be sent to all the processes.
Lines 29 through 34 demonstrate reading data from a file. After opening the file and
asserting that the file is not empty, the file is read by the <em>fscanf</em> function.
This function then stores the data from the file as an integer in the answer
variable. Note that only process 0 has the data from the file stored in answer.</p>
<p>In order to send the data from process 0 to all of the processes in the
communicator, it is necessary to <em>broadcast</em>. During a broadcast, one process
sends the same data to all of the processes. A common use of broadcasting is
to send user input to all of the processes in a parallel program. In our example,
the broadcast is sent from process 0 and looks like this:</p>
<a class="reference internal image-reference" href="../_images/Broadcast.png"><img alt="../_images/Broadcast.png" src="../_images/Broadcast.png" style="width: 700px;" /></a>
<div class="highlight-c"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cm">/* broadcast.c</span>
<span class="cm"> * ... illustrates the use of MPI_Bcast() with a scalar value...</span>
<span class="cm"> *      (compare to array version).</span>
<span class="cm"> * Joel Adams, Calvin College, April 2016.</span>
<span class="cm"> *</span>
<span class="cm"> * Usage: mpirun -np N ./broadcast</span>
<span class="cm"> *</span>
<span class="cm"> * Exercise:</span>
<span class="cm"> * - Compile and run several times,</span>
<span class="cm"> *     using 2, 4, and 8 processes</span>
<span class="cm"> * - Use source code to trace execution and output</span>
<span class="cm"> *     (noting contents of file &quot;data.txt&quot;);</span>
<span class="cm"> * - Explain behavior/effect of MPI_Bcast().</span>
<span class="cm"> */</span>

<span class="cp">#include</span> <span class="cpf">&lt;mpi.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;assert.h&gt;</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span> <span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">answer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">numProcs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">myRank</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">MPI_Init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">argc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">argv</span><span class="p">);</span>
	<span class="n">MPI_Comm_size</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">numProcs</span><span class="p">);</span>
	<span class="n">MPI_Comm_rank</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">myRank</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">myRank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">FILE</span> <span class="o">*</span><span class="n">filePtr</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="s">&quot;data.txt&quot;</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">);</span>
		<span class="n">assert</span><span class="p">(</span> <span class="n">filePtr</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="p">);</span>
		<span class="n">fscanf</span><span class="p">(</span><span class="n">filePtr</span><span class="p">,</span> <span class="s">&quot; %d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">answer</span><span class="p">);</span>
		<span class="n">fclose</span><span class="p">(</span><span class="n">filePtr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;BEFORE the broadcast, process %d&#39;s answer = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	<span class="n">myRank</span><span class="p">,</span> <span class="n">answer</span><span class="p">);</span>

	<span class="n">MPI_Bcast</span><span class="p">(</span><span class="o">&amp;</span><span class="n">answer</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MPI_INT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">);</span>

	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;AFTER the broadcast, process %d&#39;s answer = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	<span class="n">myRank</span><span class="p">,</span> <span class="n">answer</span><span class="p">);</span>

	<span class="n">MPI_Finalize</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">In this single-program, multiple data scenario, <em>all</em> processes execute the
<cite>MPI_Bcast</cite> function. The fourth parameter dictates which process id is
doing the sending to all of the other processes, who are waiting to receive.</p>
</div>
<div class="topic">
<p class="topic-title first">For further exploration</p>
<p>This program illustrates a common pattern in many parallel and distributed programs:
the master node (very typically rank 0) is the only one to read in data from a file.
It is then responsible for distributing the data to all of the other processes.
MPI also has defined collective operations for file reading and writing that
can be done in parallel. This is referred to as <em>parallel IO</em>. You could
investigate this topic further. Your system will need to support it to take
advantage of it.</p>
</div>
<div class="topic">
<p class="topic-title first">To do:</p>
<p>Run this code with several processes (8 -12). What do you observe about the
order in which the printing occurs among the processes? Is it repeatable or
does it change each time you run it?</p>
</div>
</div>
<div class="section" id="broadcast-incorporating-user-input">
<h2>09. Broadcast: incorporating user input<a class="headerlink" href="#broadcast-incorporating-user-input" title="Permalink to this headline">¶</a></h2>
<p><em>file: patternlets/MPI/09.broadcastUserInput/broadcastUserInput.c</em></p>
<p><em>Build inside 09.broadcastUserInput directory:</em></p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">broadcastUserInput</span>
</pre></div>
</div>
<p><em>Execute on the command line inside 09.broadcastUserInput directory:</em></p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">mpirun</span> <span class="o">-</span><span class="n">np</span> <span class="o">&lt;</span><span class="n">number</span> <span class="n">of</span> <span class="n">processes</span><span class="o">&gt;</span> <span class="o">./</span><span class="n">broadcastUserInput</span> <span class="o">&lt;</span><span class="n">integer</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>We can use command line arguments to incorporate user input into a program.
Command line arguments are taken care of by two functions in main(). The first
of these functions is <strong>argc</strong> which is an integer referring to the number
of arguments passed in on the command line. <strong>argv</strong> is the second function.
It is an array of pointers that points to each argument passed in.
argv[0] always holds the name of the program and in MPI argv[1] holds the
number of processes <em>when initially run using mpirun</em>. However, after the
<cite>MPI_Init</cite> function is called as in line 51 below, argc and argv are updated
to contain only the command line arguments to the program itself.</p>
<p>We modified the previous broadcast example to include an additional command line
argument, an integer. Instead of reading a scalar value from a file, this allows
a user to decide what value is broadcast in the program when it is executed. In
this example, after line 51, argc is 2, and argv[1] contains the integer you
entered at the end of the command. The function called <cite>getInput</cite> then acts like
any other C program with command line arguments.</p>
<div class="topic">
<p class="topic-title first">To do:</p>
<p>Try running the program without an argument for the number of processes.</p>
<p><strong>mpirun ./broadcastUserInput &lt;integer&gt;</strong></p>
<p>What is the default number of processes used on your system when we do not
provide a number?</p>
</div>
<div class="highlight-c"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cm">/* broadcastUserInput.c</span>
<span class="cm"> * ... illustrates the use of MPI_Bcast() with a scalar value</span>
<span class="cm"> *     obtained via a command line argument.</span>
<span class="cm"> *</span>
<span class="cm"> * Hannah Sonsalla, Macalester College 2017</span>
<span class="cm"> * Modeled from code by Joel Adams, Calvin College, April 2016.</span>
<span class="cm"> *</span>
<span class="cm"> * Usage: mpirun -np N ./broadcastUserInput &lt;integer&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Exercise:</span>
<span class="cm"> * - Compile and run several times varying the number</span>
<span class="cm"> *   of processes and integer value</span>
<span class="cm"> * - Explain the behavior you observe</span>
<span class="cm"> */</span>

<span class="cp">#include</span> <span class="cpf">&lt;mpi.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;assert.h&gt;</span><span class="cp"></span>

<span class="cp">#define MASTER 0</span>

<span class="cm">/* gets value of answer from user</span>
<span class="cm"> * @param: argc, argument count.</span>
<span class="cm"> * @param: argv, argument pointer array.</span>
<span class="cm"> * @param: myRank, rank of current process</span>
<span class="cm"> * @param: answer, variable to store value given by user</span>
<span class="cm"> * Precondition: argc is a count of the number of arguments.</span>
<span class="cm"> *              &amp;&amp; argv is a pointer array that points to the arguments.</span>
<span class="cm"> *              &amp;&amp; myRank is the rank of this MPI process.</span>
<span class="cm"> *		&amp;&amp; answer is the variable to be assigned value.</span>
<span class="cm"> * Postcondition: answer has been filled with value from user</span>
<span class="cm"> *                if given, else answer remains set to 0.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">getInput</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[],</span> <span class="kt">int</span> <span class="n">myRank</span><span class="p">,</span> <span class="kt">int</span><span class="o">*</span> <span class="n">answer</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">myRank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>  <span class="c1">// master process</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">==</span> <span class="mi">2</span><span class="p">){</span>
             <span class="o">*</span><span class="n">answer</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">MPI_Bcast</span><span class="p">(</span><span class="n">answer</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MPI_INT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span> <span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">answer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">myRank</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="kt">char</span> <span class="n">myHostName</span><span class="p">[</span><span class="n">MPI_MAX_PROCESSOR_NAME</span><span class="p">];</span>

    <span class="n">MPI_Init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">argc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">argv</span><span class="p">);</span>
    <span class="n">MPI_Comm_rank</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">myRank</span><span class="p">);</span>
    <span class="n">MPI_Get_processor_name</span> <span class="p">(</span><span class="n">myHostName</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">length</span><span class="p">);</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;BEFORE the broadcast, process %d on host &#39;%s&#39; has answer = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
             <span class="n">myRank</span><span class="p">,</span> <span class="n">myHostName</span><span class="p">,</span> <span class="n">answer</span><span class="p">);</span>

    <span class="n">getInput</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="n">myRank</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">answer</span><span class="p">);</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;AFTER the broadcast, process %d on host &#39;%s&#39; has answer = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
             <span class="n">myRank</span><span class="p">,</span> <span class="n">myHostName</span><span class="p">,</span> <span class="n">answer</span><span class="p">);</span>

    <span class="n">MPI_Finalize</span><span class="p">();</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="broadcast-send-receive-equivalent">
<h2>10. Broadcast: send receive equivalent<a class="headerlink" href="#broadcast-send-receive-equivalent" title="Permalink to this headline">¶</a></h2>
<p>file: patternlets/MPI/10.broadcastSendReceive/broadcastSendReceive.c*</p>
<p><em>Build inside 10.broadcastSendReceive directory:</em></p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">broadcastSendReceive</span>
</pre></div>
</div>
<p><em>Execute on the command line inside 10.broadcastSendReceive directory:</em></p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">mpirun</span> <span class="o">-</span><span class="n">np</span> <span class="o">&lt;</span><span class="n">number</span> <span class="n">of</span> <span class="n">processes</span><span class="o">&gt;</span> <span class="o">./</span><span class="n">broadcastSendReceive</span>
</pre></div>
</div>
<p>This example shows how to ensure that all processes have a copy of an array
created by a single <em>master</em> process. Master process 0 sends the array to each
process, all of which receive the array.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This code works to broadcast data to all processes, but this is such a common
pattern that the MPI library contains the built-in <cite>MPI_Bcast</cite> function.
Compare this example to the following one to see the value in using the single
function.</p>
</div>
<div class="highlight-c"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cm">/*</span>
<span class="cm"> * broadcastSendReceive.c</span>
<span class="cm"> * ... illustrates basic send receive functions.</span>
<span class="cm"> * Master process sends filled array to each process.</span>
<span class="cm"> *</span>
<span class="cm"> * Hannah Sonsalla, Macalester College 2017</span>
<span class="cm"> * fill and print function from code by Joel Adams, Calvin College</span>
<span class="cm"> *</span>
<span class="cm"> * Usage: mpirun -np N ./broadcastSendReceive</span>
<span class="cm"> *</span>
<span class="cm"> * Exercise:</span>
<span class="cm"> * - Compile and run, using 2, 4, and 8 processes</span>
<span class="cm"> * - Use source code to trace execution and output</span>
<span class="cm"> * </span>
<span class="cm"> */</span>

<span class="cp">#include</span> <span class="cpf">&lt;mpi.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>

<span class="cm">/* fill an array with some arbitrary values </span>
<span class="cm"> * @param: a, an int*.</span>
<span class="cm"> * @param: size, an int.</span>
<span class="cm"> * Precondition: a is the address of an array of ints.</span>
<span class="cm"> *              &amp;&amp; size is the number of ints a can hold.</span>
<span class="cm"> * Postcondition: a has been filled with arbitrary values </span>
<span class="cm"> *                { 11, 12, 13, ... }.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">fill</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">11</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* display a string, a process id, and its array values </span>
<span class="cm"> * @param: str, a char*</span>
<span class="cm"> * @param: id, an int</span>
<span class="cm"> * @param: a, an int*.</span>
<span class="cm"> * Precondition: str points to either &quot;BEFORE&quot; or &quot;AFTER&quot;</span>
<span class="cm"> *              &amp;&amp; id is the rank of this MPI process</span>
<span class="cm"> *              &amp;&amp; a is the address of an 8-element int array.</span>
<span class="cm"> * Postcondition: str, id, and a have all been written to stdout.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">print</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">str</span><span class="p">,</span> <span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="kt">int</span><span class="o">*</span> <span class="n">a</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s array sent, process %d has: {%d, %d, %d, %d, %d, %d, %d, %d}</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	   <span class="n">str</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cp">#define MAX 8</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span> <span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">numProcesses</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">array</span><span class="p">[</span><span class="n">MAX</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
    

	<span class="n">MPI_Init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">argc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">argv</span><span class="p">);</span>
	<span class="n">MPI_Comm_rank</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">id</span><span class="p">);</span>
    	<span class="n">MPI_Comm_size</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">numProcesses</span><span class="p">);</span>
    
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">fill</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">MAX</span><span class="p">);</span>
     
	<span class="n">print</span><span class="p">(</span><span class="s">&quot;BEFORE&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">array</span><span class="p">);</span>
	
	<span class="c1">// master process sends array to every process</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">numProcesses</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">MPI_Send</span><span class="p">(</span><span class="o">&amp;</span><span class="n">array</span><span class="p">,</span> <span class="n">MAX</span><span class="p">,</span> <span class="n">MPI_INT</span><span class="p">,</span> 
			    <span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">);</span>
	    <span class="p">}</span>
	<span class="p">}</span>
	
	<span class="k">else</span> <span class="p">{</span>
	    <span class="n">MPI_Recv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">array</span><span class="p">,</span> <span class="n">MAX</span><span class="p">,</span> <span class="n">MPI_INT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> 
	        <span class="mi">1</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="n">MPI_STATUS_IGNORE</span><span class="p">);</span>
	<span class="p">}</span>
	
    	<span class="n">print</span><span class="p">(</span><span class="s">&quot;AFTER&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">array</span><span class="p">);</span>
 	<span class="n">MPI_Finalize</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="broadcast-send-data-to-all-processes">
<h2>11. Broadcast: send data to all processes<a class="headerlink" href="#broadcast-send-data-to-all-processes" title="Permalink to this headline">¶</a></h2>
<p><em>file: patternlets/MPI/11.broadcast2/broadcast2.c</em></p>
<p><em>Build inside 11.broadcast2 directory:</em></p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">broadcast2</span>
</pre></div>
</div>
<p><em>Execute on the command line inside 11.broadcast2 directory:</em></p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">mpirun</span> <span class="o">-</span><span class="n">np</span> <span class="o">&lt;</span><span class="n">number</span> <span class="n">of</span> <span class="n">processes</span><span class="o">&gt;</span> <span class="o">./</span><span class="n">broadcast2</span>
</pre></div>
</div>
<p>The send and receive pattern where one process sends the same data to all
processes is used frequently. Broadcast was created for this purpose. This example
is the same as the previous example except that we send the modified array
using broadcast.</p>
<div class="highlight-c"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cm">/* broadcast2.c</span>
<span class="cm"> * ... illustrates the use of MPI_Bcast() for arrays...</span>
<span class="cm"> * Joel Adams, Calvin College, November 2009.</span>
<span class="cm"> *</span>
<span class="cm"> * Usage: mpirun -np N ./broadcast2</span>
<span class="cm"> *</span>
<span class="cm"> * Exercise:</span>
<span class="cm"> * - Compile and run, using 2, 4, and 8 processes</span>
<span class="cm"> * - Use source code to trace execution and output</span>
<span class="cm"> * - Explain behavior/effect of MPI_Bcast().</span>
<span class="cm"> */</span>

<span class="cp">#include</span> <span class="cpf">&lt;mpi.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>

<span class="cm">/* fill an array with some arbitrary values</span>
<span class="cm"> * @param: a, an int*.</span>
<span class="cm"> * @param: size, an int.</span>
<span class="cm"> * Precondition: a is the address of an array of ints.</span>
<span class="cm"> *              &amp;&amp; size is the number of ints a can hold.</span>
<span class="cm"> * Postcondition: a has been filled with arbitrary values</span>
<span class="cm"> *                { 11, 12, 13, ... }.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">fill</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">11</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* display a string, a process id, and its array values</span>
<span class="cm"> * @param: str, a char*</span>
<span class="cm"> * @param: id, an int</span>
<span class="cm"> * @param: a, an int*.</span>
<span class="cm"> * Precondition: str points to either &quot;BEFORE&quot; or &quot;AFTER&quot;</span>
<span class="cm"> *              &amp;&amp; id is the rank of this MPI process</span>
<span class="cm"> *              &amp;&amp; a is the address of an 8-element int array.</span>
<span class="cm"> * Postcondition: str, id, and a have all been written to stdout.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">print</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">str</span><span class="p">,</span> <span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="kt">int</span><span class="o">*</span> <span class="n">a</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s broadcast, process %d has: {%d, %d, %d, %d, %d, %d, %d, %d}</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	   <span class="n">str</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cp">#define MAX 8</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span> <span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">array</span><span class="p">[</span><span class="n">MAX</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
	<span class="kt">int</span> <span class="n">numProcs</span><span class="p">,</span> <span class="n">myRank</span><span class="p">;</span>

	<span class="n">MPI_Init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">argc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">argv</span><span class="p">);</span>
	<span class="n">MPI_Comm_size</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">numProcs</span><span class="p">);</span>
	<span class="n">MPI_Comm_rank</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">myRank</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">myRank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">fill</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">MAX</span><span class="p">);</span>

	<span class="n">print</span><span class="p">(</span><span class="s">&quot;BEFORE&quot;</span><span class="p">,</span> <span class="n">myRank</span><span class="p">,</span> <span class="n">array</span><span class="p">);</span>

	<span class="n">MPI_Bcast</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">MAX</span><span class="p">,</span> <span class="n">MPI_INT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">);</span>

	<span class="n">print</span><span class="p">(</span><span class="s">&quot;AFTER&quot;</span><span class="p">,</span> <span class="n">myRank</span><span class="p">,</span> <span class="n">array</span><span class="p">);</span>

	<span class="n">MPI_Finalize</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/CSInParallel200wide.png" alt="Logo"/>
            </a></p>
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Broadcast</a><ul>
<li><a class="reference internal" href="#broadcast-a-special-form-of-message-passing">08. Broadcast: a special form of message passing</a></li>
<li><a class="reference internal" href="#broadcast-incorporating-user-input">09. Broadcast: incorporating user input</a></li>
<li><a class="reference internal" href="#broadcast-send-receive-equivalent">10. Broadcast: send receive equivalent</a></li>
<li><a class="reference internal" href="#broadcast-send-data-to-all-processes">11. Broadcast: send data to all processes</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="Communication.html"
                        title="previous chapter">Communication Patterns in MPI: Basic message passing</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="Reduction_Scatter_Gather.html"
                        title="next chapter">Collective Communication</a></p>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="Reduction_Scatter_Gather.html" title="Collective Communication"
             >next</a></li>
        <li class="right" >
          <a href="Communication.html" title="Communication Patterns in MPI: Basic message passing"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Parallel Patternlets</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="MPI_Patternlets.html" >Message Passing Parallel Patternlets</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright This work is licensed under a Creative Commons Attribution-ShareAlike 3.0 Unported License.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.6.3.
    </div>
  </body>
</html>